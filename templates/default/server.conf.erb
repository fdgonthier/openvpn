# OpenVPN server config file
#
# Generated by Chef - local changes will be overwritten

port <%= node["openvpn"]["port"] %>
proto <%= node["openvpn"]["proto"] %>
<% if node["openvpn"]["type"] == "server-bridge" -%>
dev tap
<% else -%>
dev tun
<% end -%>
<% if node["openvpn"]["topology"] -%>
topology <%= node["openvpn"]["topology"] %>
<% end -%>
keepalive 10 120
comp-lzo
local <%= node["openvpn"]["local"] %>
<% if node['openvpn']['routes'] -%>
<% node["openvpn"]["routes"].each do |route| -%>
<%= route %>
<% end -%>
<% end -%>
up <%= node["openvpn"]["dir"] %>/server.up.sh

# Keys and certificates.
ca   <%= node["openvpn"]["dir"] %>/keys/ca.crt
key  <%= node["openvpn"]["dir"] %>/keys/server.key # This file should be kept secret. 
cert <%= node["openvpn"]["dir"] %>/keys/server.crt
dh   <%= node["openvpn"]["dir"] %>/keys/dh<%= node["openvpn"]["key"]["size"] %>.pem
<% if node['openvpn']['tls_auth'] -%>
tls-auth <%= node['openvpn']['tls_auth'] %> <%= node['openvpn']['tls_auth_direction'] %>
<% end -%>

ifconfig-pool-persist <%= node["openvpn"]["dir"] %>/ipp.txt

<% if node["openvpn"]["type"] == "server" -%>
<%= node["openvpn"]["type"] %> <%= node["openvpn"]["subnet"] %> <%= node["openvpn"]["netmask"] %>
<% end -%>

<% if node["openvpn"]["type"] == "server-bridge" -%>
<%= node["openvpn"]["type"] %> <%= node["openvpn"]["subnet"] %> <%= node["openvpn"]["netmask"] %> <%= node["openvpn"]["ip-pool-floor"] %> <%= node["openvpn"]["ip-pool-ceiling"] %>
<% end -%>

user nobody
group nogroup

<% if node['openvpn']['keepalive'] -%>
keepalive <%= node['openvpn']['keepalive'] %>
<% end %>

# avoid accessing certain resources on restart 
persist-key
persist-tun

# current client connections
status <%= node["openvpn"]["dir"] %>/openvpn-status.log

# logging settings.
log-append  <%= node["openvpn"]["log"] %>
verb 1  # don't spam the log with messages.
mute 10 # suppress identical messages > 10 occurances.

script-security <%= node["openvpn"]["script_security"] %>

<% if node['openvpn']['cipher'] -%>
cipher <%= node['openvpn']['cipher'] %>
<% end %>

<% if node['openvpn']['client_config_dir'] -%>
client-config-dir <%= node['openvpn']['client_config_dir'] %>
<% end %>

<% if node['openvpn']['client_to_client'] %>
client-to-client
<% end %>
